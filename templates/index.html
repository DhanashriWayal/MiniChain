<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MiniChain</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .card { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .block { border-left: 5px solid #0d6efd; }
    .tx { font-size: 0.9rem; }
    .hash { font-family: monospace; font-size: 0.8rem; color: #555; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <h1 class="text-center mb-4 text-primary">MiniChain</h1>
        <p class="text-center text-muted mb-5">A Hands-On Blockchain with Live Transactions</p>

        <!-- Add Transaction Form -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Add Transaction</h5>
          </div>
          <div class="card-body">
            <form id="txForm">
              <div class="row g-3">
                <div class="col-md-4">
                  <input type="text" class="form-control" placeholder="Sender" id="sender" required>
                </div>
                <div class="col-md-4">
                  <input type="text" class="form-control" placeholder="Receiver" id="receiver" required>
                </div>
                <div class="col-md-2">
                  <input type="number" class="form-control" placeholder="Amount" id="amount" min="1" required>
                </div>
                <div class="col-md-2">
                  <button type="submit" class="btn btn-success w-100">Send</button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Mine Button -->
        <div class="text-center mb-4">
          <button id="mineBtn" class="btn btn-lg btn-warning">Mine Block</button>
          <div id="miningStatus" class="mt-2 text-muted"></div>
        </div>

        <!-- Blockchain Display -->
        <div id="chain"></div>
      </div>
    </div>
  </div>

  <script>
    const API = '/api';

    // Load chain
    async function loadChain() {
      const res = await fetch(`${API}/chain`);
      const data = await res.json();
      renderChain(data);
    }

    // Render full chain
    function renderChain(data) {
      const chainDiv = document.getElementById('chain');
      chainDiv.innerHTML = '';

      data.chain.forEach((block, i) => {
        const isValid = i === 0 || block.previous_hash === data.chain[i-1].hash;
        const badge = data.valid && isValid ? 'success' : 'danger';

        const blockEl = `
          <div class="card mb-3 block">
            <div class="card-header d-flex justify-content-between">
              <strong>Block #${block.index}</strong>
              <span class="badge bg-${badge}">${badge === 'success' ? 'Valid' : 'Invalid'}</span>
            </div>
            <div class="card-body">
              <p><strong>Hash:</strong> <span class="hash">${block.hash}</span></p>
              <p><strong>Previous:</strong> <span class="hash">${block.previous_hash}</span></p>
              <p><strong>Timestamp:</strong> ${new Date(block.timestamp * 1000).toLocaleString()}</p>
              <p><strong>Nonce:</strong> ${block.nonce}</p>

              ${block.transactions.length > 0 ? `
              <hr>
              <h6>Transactions (${block.transactions.length})</h6>
              <ul class="list-group list-group-flush">
                ${block.transactions.map(tx => `
                  <li class="list-group-item tx p-2">
                    <strong>${tx.sender}</strong> â†’ <strong>${tx.receiver}</strong>: 
                    <span class="text-success">${tx.amount} coins</span>
                  </li>`).join('')}
              </ul>` : '<p class="text-muted">No transactions</p>'}
            </div>
          </div>`;
        chainDiv.innerHTML += blockEl;
      });

      document.getElementById('miningStatus').innerHTML = 
        `<small class="text-success">Chain valid: ${data.valid ? 'Yes' : 'No'} | Length: ${data.length}</small>`;
    }

    // Add transaction
    document.getElementById('txForm').onsubmit = async (e) => {
      e.preventDefault();
      const sender = document.getElementById('sender').value;
      const receiver = document.getElementById('receiver').value;
      const amount = document.getElementById('amount').value;

      await fetch(`${API}/transaction`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sender, receiver, amount: parseInt(amount) })
      });

      e.target.reset();
      loadChain();
    };

    // Mine block
    document.getElementById('mineBtn').onclick = async () => {
      const btn = document.getElementById('mineBtn');
      const status = document.getElementById('miningStatus');
      btn.disabled = true;
      status.innerHTML = '<span class="text-warning">Mining...</span>';

      await fetch(`${API}/mine`, { method: 'POST', body: JSON.stringify({}) });

      btn.disabled = false;
      loadChain();
    };

    // Auto-refresh every 5 sec
    setInterval(loadChain, 5000);
    loadChain(); // Initial load
  </script>
</body>
</html>